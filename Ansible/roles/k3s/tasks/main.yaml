---
- name: Ensure required packages are installed
  pacman:
    name:
      - curl
      - helm
    state: present
    update_cache: true

- name: Download k3s install script
  get_url:
    url: https://get.k3s.io
    dest: "{{ k3s_install_script }}"
    mode: "0755"

- name: Install k3s server
  command: "{{ k3s_install_script }}"
  environment:
    INSTALL_K3S_EXEC: >
      {% for item in k3s_disable_components %}
      --disable {{ item }}
      {% endfor %}
  args:
    creates: /usr/local/bin/k3s

- name: Enable and start k3s service
  systemd:
    name: k3s
    enabled: true
    state: started

- name: Wait for kubeconfig to be created
  wait_for:
    path: "{{ k3s_kubeconfig_src }}"
    timeout: 60

- name: Ensure .kube directory exists
  file:
    path: "/home/tklas/.kube"
    state: directory
    owner: "{{ uid }}"
    group: "{{ guid }}"
    mode: "0755"

- name: Copy kubeconfig to ~/.kube/local.yaml
  copy:
    src: "{{ k3s_kubeconfig_src }}"
    dest: "{{ k3s_kubeconfig_dest }}"
    remote_src: true
    owner: "{{ uid }}"
    group: "{{ guid }}"
    mode: "0600"

